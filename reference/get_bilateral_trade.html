<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Bilateral trade data — get_bilateral_trade • whep</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bilateral trade data — get_bilateral_trade"><meta name="description" content="Reports trade between pairs of countries in given years."><meta property="og:description" content="Reports trade between pairs of countries in given years."><meta property="og:image" content="https://eduaguilera.github.io/whep/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">whep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/trade-sources-coverage.html">Trade sources year coverage</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/eduaguilera/whep/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Bilateral trade data</h1>
      <small class="dont-index">Source: <a href="https://github.com/eduaguilera/whep/blob/main/R/bilateral_trade.R" class="external-link"><code>R/bilateral_trade.R</code></a></small>
      <div class="d-none name"><code>get_bilateral_trade.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Reports trade between pairs of countries in given years.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">get_bilateral_trade</span><span class="op">(</span>trade_version <span class="op">=</span> <span class="cn">NULL</span>, cbs_version <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-trade-version">trade_version<a class="anchor" aria-label="anchor" href="#arg-trade-version"></a></dt>
<dd><p>File version used for bilateral trade input.
See <a href="whep_inputs.html">whep_inputs</a> for version details.</p></dd>


<dt id="arg-cbs-version">cbs_version<a class="anchor" aria-label="anchor" href="#arg-cbs-version"></a></dt>
<dd><p>File version passed to <code><a href="get_wide_cbs.html">get_wide_cbs()</a></code> call.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A tibble with the reported trade between countries. For efficient
memory usage, the tibble is not exactly in tidy format.
It contains the following columns:</p><ul><li><p><code>year</code>: The year in which the recorded event occurred.</p></li>
<li><p><code>item_cbs_code</code>: FAOSTAT internal code for the item that is being traded.
For code details see e.g. <code><a href="add_item_cbs_name.html">add_item_cbs_name()</a></code>.</p></li>
<li><p><code>bilateral_trade</code>: Square matrix of <code>NxN</code> dimensions where <code>N</code> is the
total number of countries being considered. The matrix row and column
names are exactly equal and they represent country codes.</p><ul><li><p>Row name: The code of the country where the data is from. For code
details see e.g. <code><a href="add_area_name.html">add_area_name()</a></code>.</p></li>
<li><p>Column name: FAOSTAT internal code for the country that is importing the
item. See row name explanation above.</p></li>
</ul><p>If <code>m</code> is the matrix, the value at <code>m["A", "B"]</code> is the trade in tonnes
from country <code>"A"</code> to country <code>"B"</code>, for the corresponding year and item.
The matrix can be considered <em>balanced</em>. This means:</p><ul><li><p>The sum of all values from row <code>"A"</code>, where <code>"A"</code> is any country,
should match the total exports from country <code>"A"</code> reported in the
commodity balance sheet (which is considered more accurate for totals).</p></li>
<li><p>The sum of all values from column <code>"A"</code>, where <code>"A"</code> is any country,
should match the total imports into country <code>"A"</code> reported in the
commodity balance sheet (which is considered more accurate for totals).</p></li>
</ul><p>The sums may not be exactly the expected values because of precision
issues and/or the iterative proportional fitting algorithm not converging
fast enough, but should be relatively very close to the desired totals.</p></li>
</ul><p>The step by step approach to obtain this data tries to follow the FABIO
model and is explained below. All the steps are performed separately for
each group of year and item.</p><ul><li><p>From the FAOSTAT reported bilateral trade, there are sometimes two values
for one trade flow: the exported amount claimed by the reporter country
and the import amount claimed by the partner country. Here, the export
data was preferred, i.e., if country <code>"A"</code> says it exported <code>X</code> tonnes to
country <code>"B"</code> but country <code>"B"</code> claims they got <code>Y</code> tonnes from country
<code>"A"</code>, we trust the export data <code>X</code>. This choice is only needed if there
exists a reported amount from both sides. Otherwise, the single existing
report is chosen.</p></li>
<li><p>Complete the country data, that is, add any missing combinations of
country trade with NAs, which will be estimated later. In the matrix
form, this doesn't increase the memory usage since we had to build a
matrix anyway (for the balancing algorithm), and the <em>empty</em> parts also
take up memory. This is also done for total imports/exports from the
commodity balance sheet, but these are directly filled with 0s instead.</p></li>
<li><p>The total imports and exports from the commodity balance sheet are
balanced by downscaling the largest of the two to match the lowest.
This is done in the following way:</p><ul><li><p>If <code>total_imports &gt; total_exports</code>: Set <code>import</code> as
<code>total_exports * import / total_import</code>.</p></li>
<li><p>If <code>total_exports &gt; total_exports</code>: Set <code>export</code> as
<code>total_exports * export / total_export</code>.</p></li>
</ul></li>
<li><p>The missing data in the matrix must be estimated. It's done like this:</p><ul><li><p>For each pair of exporter <code>i</code> and importer <code>j</code>, we estimate a bilateral
trade <code>m[i, j]</code> using the export shares of <code>i</code> and import shares of <code>j</code>
from the commodity balance sheet:</p><ul><li><p><code>est_1 &lt;- exports[i] * imports[j] / sum(imports)</code>, i.e., total
exports of country <code>i</code> spread among other countries' import shares.</p></li>
<li><p><code>est_2 &lt;- imports[j] * exports[i] / sum(exports)</code>, i.e. total
imports of country <code>j</code> spread among other countries' export shares.</p></li>
<li><p><code>est &lt;- (est_1 + est_2) / 2</code>, i.e., the mean of both estimates.</p></li>
</ul><p>In the above computations, exports and imports are the original values
before they were balanced.</p></li>
<li><p>The estimates for data that already existed (i.e. non-NA) are discarded.
For the ones left, for each row (i.e. exporter country), we get the
difference between its balanced total export and the sum of original
non-estimated data. The result is the <em><code>gap</code></em> we can actually fill with
estimates, so as to not get past the reported total export. If the sum
of non-discarded estimates is larger, it must be downscaled and spread
by computing
<code>gap * non_discarded_estimate / sum(non_discarded_estimates)</code>.</p></li>
<li><p>The estimates are divided by a <em>trust factor</em>, in the sense that we
don't rely on the whole value, thinking that a non-present value might
actually be because that specific trade was 0, so we don't overestimate
too much. The chosen factor is 10%, so only 10% of the estimate's value
is actually used to fill the NA from the original bilateral trade
matrix.</p></li>
</ul></li>
<li><p>The matrix is balanced, as mentioned before, using the
<a href="https://en.wikipedia.org/wiki/Iterative_proportional_fitting" class="external-link">iterative proportional fitting algorithm</a>. The target sums for rows and columns are respectively the balanced
exports and imports computed from the commodity balance sheet. The
algorithm is performed directly using the <a href="https://CRAN.R-project.org/package=mipfp" class="external-link">mipfp R package</a>.</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Note: These are smaller samples to show outputs, not the real data.</span></span></span>
<span class="r-in"><span><span class="co"># For all data, call the function with default versions (i.e. no arguments).</span></span></span>
<span class="r-in"><span><span class="fu">get_bilateral_trade</span><span class="op">(</span></span></span>
<span class="r-in"><span>  trade_version <span class="op">=</span> <span class="st">"example"</span>,</span></span>
<span class="r-in"><span>  cbs_version <span class="op">=</span> <span class="st">"example"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Fetching files for commodity_balance_sheet...</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Fetching files for bilateral_trade...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 72 × 3</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     year item_cbs_code bilateral_trade  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 1</span>  <span style="text-decoration: underline;">1</span>995          <span style="text-decoration: underline;">2</span>630 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 2</span>  <span style="text-decoration: underline;">2</span>001          <span style="text-decoration: underline;">2</span>733 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 3</span>  <span style="text-decoration: underline;">2</span>005          <span style="text-decoration: underline;">2</span>671 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">2</span>017          <span style="text-decoration: underline;">2</span>513 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 5</span>  <span style="text-decoration: underline;">2</span>011          <span style="text-decoration: underline;">2</span>601 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">2</span>011          <span style="text-decoration: underline;">2</span>655 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 7</span>  <span style="text-decoration: underline;">2</span>015          <span style="text-decoration: underline;">2</span>558 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 8</span>  <span style="text-decoration: underline;">2</span>014          <span style="text-decoration: underline;">2</span>577 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 9</span>  <span style="text-decoration: underline;">2</span>000          <span style="text-decoration: underline;">2</span>625 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">10</span>  <span style="text-decoration: underline;">2</span>018          <span style="text-decoration: underline;">2</span>661 <span style="color: #949494;">&lt;dbl [187 × 187]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># ℹ 62 more rows</span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Catalin Covaci, Eduardo Aguilera, <a href="https://erc.europa.eu/homepage" class="external-link"><img src="https://erc.europa.eu/themes/custom/erc_theme/ERC_FAVICON.png" width="55" alt="European Research Council"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

