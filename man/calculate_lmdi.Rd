% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_lmdi.R
\name{calculate_lmdi}
\alias{calculate_lmdi}
\title{Calculate LMDI decomposition.}
\usage{
calculate_lmdi(
  data,
  identity,
  identity_labels = NULL,
  time_var = year,
  periods = NULL,
  periods_2 = NULL,
  analysis_by = NULL,
  rolling_mean = NULL,
  output_format = "clean",
  verbose = TRUE
)
}
\arguments{
\item{data}{A data frame containing the variables for decomposition. Must
include all variables specified in the identity, time variable, and any
grouping variables.}

\item{identity}{Character. Decomposition identity in format
\code{"target:factor1*factor2*..."}. The target appears before the colon,
factors after, separated by asterisks. Supports explicit ratios with
\code{/} and structural decomposition with \verb{[]}.}

\item{identity_labels}{Named character vector. Custom labels for factors
to use in output instead of variable names. Default: NULL uses variable
names as-is.}

\item{time_var}{Unquoted name of the time variable column in the data.
Default: \code{year}. Must be numeric or coercible to numeric.}

\item{periods}{Numeric vector. Years defining analysis periods. Each
consecutive pair defines one period. Default: NULL uses all available
years.}

\item{periods_2}{Numeric vector. Additional period specification for
complex multi-period analyses. Default: NULL.}

\item{analysis_by}{Character vector. Grouping variables for performing
separate decompositions. Default: NULL (single decomposition for all
data).}

\item{rolling_mean}{Numeric. Window size for rolling mean smoothing
applied before decomposition. Default: NULL (no smoothing).}

\item{output_format}{Character. Format of output data frame. Options:
\code{"clean"} (default) or \code{"detailed"}.}

\item{verbose}{Logical. If TRUE (default), prints progress messages during
decomposition.}
}
\value{
A tibble with LMDI decomposition results containing:
\itemize{
\item Time variables and grouping variables (if specified).
\item \code{additive}: Additive contributions (sum equals total change in target).
\item \code{multiplicative}: Multiplicative indices (product equals target ratio).
\item \code{multiplicative_log}: Log of multiplicative indices.
\item Period identifiers and metadata.
}
}
\description{
Performs LMDI (Log Mean Divisia Index) decomposition analysis with
flexible identity parsing, automatic factor detection, and support for
multiple periods and groupings. Supports sectoral decomposition using
bracket notation for both summing and grouping operations.
}
\details{
The LMDI method decomposes changes in a target variable into contributions
from multiple factors using logarithmic mean weights. This implementation
supports:

\strong{Flexible identity specification:}
\itemize{
\item Automatic factor detection from identity string.
\item Support for ratio calculations (implicit division).
\item Sectoral aggregation with \verb{[]} notation.
\item Sectoral grouping with \code{{}} notation.
}

\strong{Period analysis:}
The function can decompose changes over single or multiple periods.
Periods are defined by consecutive pairs in the \code{periods} vector.

\strong{Grouping capabilities:}
Use \code{analysis_by} to perform separate decompositions for different
groups (e.g., countries, regions) while maintaining consistent factor
structure.
}
\section{Identity Syntax}{

The identity parameter uses a special syntax to define decomposition:

\strong{Basic format:} \code{"target:factor1*factor2*factor3"}

\strong{Simple decomposition (no sectors):}
\itemize{
\item Basic: \code{"emissions:gdp*(emissions/gdp)"}
\item Complete: \code{"emissions:(emissions/gdp)*(gdp/population)*population"}
}

\strong{Understanding bracket notation:}

Square brackets \verb{[]} specify variables to sum across categories, enabling
structural decomposition. The bracket aggregates values BEFORE calculating
ratios.

\strong{Single-level structural decomposition:}
\itemize{
\item \code{"emissions:activity*(activity[sector]/activity)*(emissions[sector]/activity[sector])"}
\item Creates 3 factors: Activity level, Sectoral structure, Sectoral
intensity.
}

\strong{Multi-level structural decomposition:}
\itemize{
\item Two levels: \code{"emissions:activity*(activity[sector]/activity)*(activity[sector+fuel]/activity[sector])*(emissions[sector+fuel]/activity[sector+fuel])"}
\item Creates 4 factors: Activity level, Sector structure, Fuel structure,
Sectoral-fuel intensity.
}
}

\section{Data Requirements}{

The input data frame must contain:
\itemize{
\item All variables mentioned in the identity.
\item The time variable (default: "year").
\item Grouping variables if using \code{analysis_by}.
\item No missing values in key variables for decomposition periods.
}
}

\examples{
# Simple LMDI decomposition
data <- tibble::tribble(
  ~year, ~country, ~emissions, ~gdp, ~population,
  2010,  "ESP",    100,        1000, 46,
  2011,  "ESP",    105,        1050, 46.5,
  2012,  "ESP",    110,        1100, 47,
  2013,  "ESP",    115,        1150, 47.5,
  2014,  "ESP",    120,        1200, 48,
  2015,  "ESP",    125,        1250, 48.5,
  2010,  "FRA",    200,        2000, 65,
  2011,  "FRA",    210,        2100, 65.5,
  2012,  "FRA",    220,        2200, 66,
  2013,  "FRA",    230,        2300, 66.5,
  2014,  "FRA",    240,        2400, 67,
  2015,  "FRA",    250,        2500, 67.5
)

# Example: Complete form with multiple factors
calculate_lmdi(
  data,
  identity = "emissions:(emissions/gdp)*(gdp/population)*population",
  time_var = year,
  analysis_by = "country",
  verbose = FALSE
)
}
