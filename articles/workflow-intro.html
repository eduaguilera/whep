<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Follow the workflow • whep</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Follow the workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">whep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/trade-sources-coverage.html">Trade sources year coverage</a></li>
    <li><a class="dropdown-item" href="../articles/workflow-intro.html">Follow the workflow</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/eduaguilera/whep/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Follow the workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/eduaguilera/whep/blob/main/vignettes/workflow-intro.Rmd" class="external-link"><code>vignettes/workflow-intro.Rmd</code></a></small>
      <div class="d-none name"><code>workflow-intro.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="git-intro">Git intro<a class="anchor" aria-label="anchor" href="#git-intro"></a>
</h2>
<div class="section level3">
<h3 id="cloning-the-repository">Cloning the repository<a class="anchor" aria-label="anchor" href="#cloning-the-repository"></a>
</h3>
<p>To get started with Git, you need your operating system to recognize
Git commands. We will assume you are on Windows, so you will have to
install Git from <a href="https://git-scm.com/downloads/win" class="external-link">here</a>.
If you do not know whether it is the 32 or 64 bits version, you most
likely need the 64 bit one. You should now have something called ‘Git
Bash’ installed, which is like a command line tool (similar to Windows
CMD). You can open Git Bash inside a specific directory (this is just a
technical name for folders and I will use it from now on) by
right-clicking your desired directory in the file explorer and selecting
‘Open Git Bash here’. However, I would recommend you to learn some basic
commands to navigate from the command line itself (from now on,
<strong>writing <code>&lt;some-text&gt;</code> is not part of the
command</strong>, I just use it as a <strong>placeholder</strong> for
what you need to write there):</p>
<ul>
<li>
<p>Print your current directory:</p>
<pre><code><span><span class="va">pwd</span></span></code></pre>
<p>This is just useful so you can see where you are right now.</p>
</li>
<li>
<p>List files from your current directory:</p>
<pre><code><span><span class="va">ls</span></span></code></pre>
<p>Suppose you do not know the exact path to follow but you know it is
inside a certain subdirectory from the one you are in right now. Listing
everything in the current directory with <code>ls</code> is a useful way
to spot which subdirectory you are looking for, so that you can then
navigate inside it with <code>cd</code>.</p>
</li>
<li>
<p>Move to another directory relative to the one you are in right
now:</p>
<pre><code>cd &lt;relative-path-where-to-move&gt;</code></pre>
</li>
</ul>
<p>You can use <code>ls</code> and <code>cd &lt;relative-path&gt;</code>
repeatedly until you are in the directory where you want to place a
subdirectory containing the repository. Again, you can double check that
using <code>pwd</code>.</p>
<p>We assume here that the repository you want to contribute to already
exists. You can go to its page on GitHub and copy the URL as seen in the
image below:</p>
<p><img src="imgs/copy_repo_url.png" alt="Where to copy URL from"></p>
<p>The git terminology used for ‘downloading’ a repository to our local
file system is ‘cloning’. We can clone a remote repository (in this case
from GitHub) using the following command:</p>
<pre><code>git clone &lt;url-you-copied&gt;</code></pre>
<p>This is called cloning via HTTPS. A browser should open and ask you
to introduce your GitHub credentials. There are other ways of cloning
like SSH, but that is out of the scope of this guide.</p>
</div>
<div class="section level3">
<h3 id="pulling-remote-changes">Pulling remote changes<a class="anchor" aria-label="anchor" href="#pulling-remote-changes"></a>
</h3>
<p>Now a new directory should have been created with the content of the
repository in your local file system. From now on we will see the basic
git commands that you would need in daily usage. We assume you are
inside the repository. We explain them with an example.</p>
<p>Suppose you want to start contributing to this repository. A good
practice (and one that we will enforce to use) is to make your own code
changes in a ‘different place’ than the ones you currently see in the
repository. The things you see now are in what it is called the ‘main
branch’, and you will make your code changes in a ‘new branch’, which
will start with the same content as the main one, but will then evolve
with different changes. If you have not done anything yet, you should be
in the main branch (maybe it is called ‘main’ or ‘master’, these are
just conventions, but I will assume it is called ‘main’). You can use
the command <code>git status</code> to check this (do not mind that my
terminal looks different in the screenshots, you can use the same
commands in Git Bash):</p>
<p><img src="imgs/git_status_command.png" alt="Using git status"></p>
<p>Your local version of a repository does not need to match the remote
version (the one we store in GitHub in this case), but before you start
your work on a new branch, you should keep your main branch up to date
in case someone added new code in the GitHub repository since the last
time you checked. We get any new remote changes to the local repository
by using the command</p>
<pre><code>git pull</code></pre>
<p><img src="imgs/git_pull_command.png" alt="Using git pull outputs 'Already up to date'"></p>
<p>In this case I already had all the remote changes, and that is why
the message says ‘Already up to date’, but the message will be different
if you had missing changes. This is the ‘easy way’ to do it. The command
<code>git pull</code> tries to fetch changes from the equivalent remote
branch, i.e., the one that has the same name on remote as it has on your
local repository. This may not always work as expected so there is a way
to always specify from which remote branch you want to get these changes
(and I highly recommend always using it explicitly):</p>
<pre><code>git pull origin &lt;name-of-remote-branch&gt;</code></pre>
<p>For example, imagine you asked someone for help on your own branch
and they added some new changes on your branch, that you do not have
locally. Then, if your branch is called <code>my-branch</code>, and you
are already on your branch locally, you would want to use the
command</p>
<pre><code>git pull origin my-branch</code></pre>
<p>Likewise, for the first example shown here (keeping the main branch
updated), I would always be explicit:</p>
<pre><code>git pull origin main</code></pre>
</div>
<div class="section level3">
<h3 id="creating-our-own-branch">Creating our own branch<a class="anchor" aria-label="anchor" href="#creating-our-own-branch"></a>
</h3>
<p>After the pull, we are now safely up to date with the remote changes.
Now it is time to learn how to create our own ‘branch’, from which we
will start working on new code. We use the following command:</p>
<pre><code>git checkout -b &lt;name-of-branch&gt;</code></pre>
<p><img src="imgs/branch_creation_command.png" alt="Using branch creation command"></p>
<p>The command <code>git checkout &lt;name-of-branch&gt;</code> is used
to change from one branch to another (so that you will now see the files
and changes that are in that branch). Additionally, if we add the
<code>-b</code> option, it will create the branch with the given name if
it does not already exist, which is our case in this example. The branch
name should be something like <code>author/name-of-branch</code>. Thus,
some common practices for naming your branches (and that we should
follow) are:</p>
<ul>
<li>They do not contain caps (all lowercase)</li>
<li>Words are separated with dashes (<code>-</code>)</li>
<li>The name includes the author and some descriptive name separated by
a slash (<code>/</code>)</li>
<li>The descriptive name should ideally start with an action (a verb) in
imperative style (fix, create, test…).</li>
</ul>
<p>If Ermenegildo wants to create some code for preprocessing bilateral
trade data, an acceptable branch name could be
<code>ermenegildo/preprocess-bilateral-trade-data</code>.</p>
</div>
<div class="section level3">
<h3 id="adding-changes-to-our-branch">Adding changes to our branch<a class="anchor" aria-label="anchor" href="#adding-changes-to-our-branch"></a>
</h3>
<p>Now you are in your own branch and you can start working on your
changes. While you work on them, you should keep track of changes with
git. We can add all changes using the command</p>
<pre><code>git add .</code></pre>
<p>Here the dot means ‘this directory’, which essentially adds all new
changes, i.e. all things inside the directory. We can add just a
specific file instead using the command</p>
<pre><code>git add &lt;relative-name-of-file&gt;</code></pre>
<p><img src="imgs/add_all_git_changes.png" alt="Add all git changes"></p>
<p>After adding our changes, we must ‘commit’ them. This commit step is
what actually saves your changes in the git history. You do this with
the command</p>
<pre><code>git commit -m 'Some descriptive message for your changes'</code></pre>
<p>A common practice for commit messages is to start them with a verb in
infinitive (imperative style), indicating an action that was performed,
e.g.,
<code>'Create tests for bilateral trade data preprocessing'</code>.</p>
<p><img src="imgs/commit_changes.png" alt="Commit the changes"></p>
<p>A common practice is to make small commits, that is, include just a
few changes in each commit, so that it is easier to keep track of your
work’s history, instead of just having a single commit when you are done
with everything. Ultimately, the amount of commits is your decision, but
should not be just one commit per branch.</p>
</div>
<div class="section level3">
<h3 id="pushing-our-changes">Pushing our changes<a class="anchor" aria-label="anchor" href="#pushing-our-changes"></a>
</h3>
<p>After committing, we now have our changes in local git history, but
we should probably also add them to the remote GitHub repository. We do
this using the command</p>
<pre><code>git push origin &lt;name-of-branch&gt;</code></pre>
<p>Now you should be able to see your changes in your own branch from
GitHub itself, you just need to select your own branch instead of the
<code>main</code> one.</p>
<p>You should remember to push your changes regularly to the remote
repository. Otherwise you risk having a bunch of code features in your
local computer that could be lost if something happened to it. This is
aligned with the previous suggestion of creating many smaller commits as
opposed to giant ones, so that you can also push them more
frequently.</p>
</div>
<div class="section level3">
<h3 id="creating-a-pull-request">Creating a pull request<a class="anchor" aria-label="anchor" href="#creating-a-pull-request"></a>
</h3>
<p>Suppose you are done with your changes and you want to add these to
the main branch. Mixing one branch with another is known as ‘merging’.
In this case we would like to merge our new branch with the main branch.
This can be done forcefully, but the common practice we will be
following is to create what is known as a ‘Pull request’ from our branch
into the main one, and we do this directly from GitHub, once we have
pushed all of our changes.</p>
<p><img src="imgs/new_pull_request.png" alt="Click 'New pull request' in GitHub"></p>
<p><img src="imgs/create_pull_request.png" alt="Click 'Create pull request'"></p>
<p>Here you can see all the changes you made (that differ from the main
branch) before clicking again ‘Create pull request’. Then you will see
the following, where you should add some title and description to
explain what you have done. You finally click ‘Create pull request’
again.</p>
<p><img src="imgs/add_pr_title_description.png" alt="Add title and description and click 'Create pull request'"></p>
<p>Now the Pull Request (often abbreviated as PR) is created and the
next step is to ask for someone’s review.</p>
<p><img src="imgs/add_people_review_pr.png" alt="Adding people to review your PR"></p>
<p>Ideally these changes would not be merged until someone else reviews
your code. This person might find things you have to change and request
these changes before merging, so you would have to keep working on your
branch until they are satisfied. Then they would accept your changes and
you would be ready to merge your branch into the main one, and the
process would be done.</p>
<p>However, sometimes there is an additional step that must be passed
before merging, which is related to automatic code checks, e.g. check
whether your code is well formatted and whether it passes all tests
successfully. If configured, these can run automatically when creating a
Pull Request. We will indeed work with them, but we will explain these
automatic checks better in the <a href="#automatic-checks-on-pull-requests">Automatic checks on Pull
Requests section</a>.</p>
<p>While working on your own branch, others may have merged their own
branches into the main branch and then your own branch would be
outdated. When creating a Pull Request yourself, you should make sure
your branch is also up to date with everything already on the main
branch. Recall from <a href="#pulling-remote-changes">the pulling remote
changes section</a> that we can do this with the command</p>
<pre><code>git pull origin main</code></pre>
<p>Even if you are locally on your own branch and directly try to fetch
changes from a different remote one (in this case <code>main</code>),
this works as expected, that is, it tries to merge all new changes from
the <code>main</code> branch into your own local one. This automatic
merge works most of the times, but sometimes you may find conflicts,
because the program does not know how to combine everything neatly. If
this happens, you must manually check which parts of the code should be
kept. In the next section we explain how to solve conflicts.</p>
</div>
<div class="section level3">
<h3 id="solving-conflicts">Solving conflicts<a class="anchor" aria-label="anchor" href="#solving-conflicts"></a>
</h3>
<p>As noted in the previous section, sometimes when you
<code>git pull</code> from another branch or from the same remote one
(if you are missing some changes), you can find conflicts. A conflict
looks like this:</p>
<pre><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
this is my content
that I just added
=======
this is some different conflicting content
from the branch I pulled from
&gt;&gt;&gt;&gt;&gt;&gt;&gt; some_branch_name</code></pre>
<p>So in a conflict, there are at least three lines the were added by
git to separate the conflicting parts. The conflict starts at the line
<code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</code>, and until we get to the
<code>=======</code> line, the lines in between are the content
<em>we</em> added. Then from this one until the end
<code>&gt;&gt;&gt;&gt;&gt;&gt;&gt; some_branch_name</code>, the lines in
between are the content that <em>someone else</em> added and we did not
have yet. Then solving a conflict essentially means removing these three
lines added by git. We have three options here. You will have to decide
which one you want depending on the situation:</p>
<ul>
<li>
<p>Keep only our content. Solving the conflict would involve
removing all lines except:</p>
<pre><code>this is my content
that I just added</code></pre>
</li>
<li>
<p>Keep only the other content. We remove everything except:</p>
<pre><code>this is some different conflicting content
from the branch I pulled from</code></pre>
</li>
<li>
<p>Keep some (or all) content from both parts, or even adapt it
adding other things. We remove the three lines added by git and
everything else we do not want to keep, leaving something like a
mix:</p>
<pre><code>this is my content
that I just added
this is some different conflicting content</code></pre>
</li>
</ul>
<p>If you have to find conflicts (I advise to do it manually), you could
use some text finding tool in your editor, and look for the text
<code>HEAD</code>, as this always appears in the first line of a
conflict. After you solved all conflicts, you have to do the rest of the
steps explained in previous sections, involving <code>git add</code> and
<code>git commit</code>, because a pull also counts as a code change, so
you have to make a commit from it. In case you are wondering, when you
perform a pull without conflicts, you are not creating a commit yourself
but git does it for you, automatically. So whether you solved the
conflicts or git did it for you, there will always be a commit
representing it.</p>
</div>
</div>
<div class="section level2">
<h2 id="r-package-and-renv-intro">R package and renv intro<a class="anchor" aria-label="anchor" href="#r-package-and-renv-intro"></a>
</h2>
<div class="section level3">
<h3 id="project-structure">Project structure<a class="anchor" aria-label="anchor" href="#project-structure"></a>
</h3>
<p>It seems clear that even though we would work fine with bare R
scripts that are run directly, when working on a large project it makes
sense to have some kind of file structure, to keep everything organized.
You can build your ad-hoc file structures, and you could probably come
up with something rather simple. Here, instead, we will focus on using
the standard structure of an R package. This is a standard everyone has
to follow if they want their projects to turn into packages which can be
publicly downloaded by anyone from the <a href="https://cran.r-project.org/" class="external-link">CRAN repositories</a>. Just the same
way you do, e.g., <code>install.packages(tidyverse)</code> to install
all Tidyverse packages, if you follow this standard R package structure,
you can upload your package and one could do
<code>install.packages(your_package)</code> the same way.</p>
<p>Even if you do not want to upload a package, there are still
advantages if you follow this structure. This is the one we will follow,
so the rest of this section will try to explain its different parts,
that will all become part of our workflow.</p>
<p>This is the whole structure of an R package:</p>
<p><img src="imgs/r_package_structure.png" alt="Structure of an R package"></p>
<p>Luckily, there are a lot of files there that you do not need to know
about, at least for now, so we will try to explain the most important
ones in the next sections.</p>
<p>There is a whole <a href="https://r-pkgs.org/" class="external-link">R packages book</a>
which I followed myself to setup the basics for our project. It is very
well written and available for free online, so if you are interested in
knowing more about R packages and their project structure, I recommend
checking the book.</p>
</div>
<div class="section level3">
<h3 id="virtual-environments-with-renv">Virtual environments with renv<a class="anchor" aria-label="anchor" href="#virtual-environments-with-renv"></a>
</h3>
<p>We just mentioned we were going to use the R package structure, and
it seems R package developers do not use <code>renv</code>… Or do they?
At least they do not seem to include <code>renv</code> related files in
their package repositories… Well, why should <em>we</em> use it then?
While writing this guide I was a bit confused myself about mixing both
things, but my conclusion was that it just does not hurt in any way,
<code>renv</code> just makes things easier without apparent drawbacks
(do tell me if you know of any). When creating packages, you want to
make sure they work on fresh installations, i.e., computers that do not
have anything unnecessary installed. The package creation process as we
will use it, does not need to know anything about <code>renv</code>, so
we should be fine. The packages use their own file called
<code>DESCRIPTION</code> which includes information about the other
packages it needs as dependencies, as we will see later on. So we can
just try to benefit from using virtual environments.</p>
<p>OK, but what are virtual environments? This is a fancy term, but its
practical meaning is quite simple. First consider the following:</p>
<ul>
<li>If you are not using them, it means you just have a global R
installation in your computer, and whenever you install a package, it is
installed globally.</li>
<li>If you want to run someone’s code and they use a bunch of packages
that you usually do not, you would have to install all of them to be
able to run their code, and these would mix with all your other
packages. If you want to uninstall them after that, you would have to do
a lot of manual work to make sure you know all of them (some package
dependencies could have also been installed, and you cannot be sure if
they were only used for these packages or also some other package that
you already had).</li>
<li>If you want to write some code that uses some packages, and you want
another person to run it, you should make a list of the packages used
only in this project, because they should not have to install any other
packages you have from other projects but are not necessary here. If you
do not even make this ‘package list’, the other person should have to go
through your whole code or run it and install a new package every time
the code fails because of a missing one. Overall, this is a poor
experience.</li>
</ul>
<p>Virtual environments try to fix this. Essentially, they provide a
‘local’ installation of packages, that are only visible inside your
project, and do not get mixed at all with those from your global R
installation or from other individual projects. In practice, a virtual
environment is just a folder containing installed packages, isolated
from the folder that contains your global R installation. It is like
having several different R installations, each one with their own
packages and versions.</p>
<p>Chances are you follow this guide with an existing repository that is
already using <code>renv</code> (then you can skip the
<code>renv::init()</code> step). If this were not the case, open an R
prompt in the root directory of your project and run inside the
prompt:</p>
<pre><code><span><span class="fu">renv</span><span class="fu">::</span><span class="fu">init</span><span class="op">(</span><span class="op">)</span></span></code></pre>
<p>It will probably ask to close and reopen a clean prompt. After that,
every time we open an R prompt inside our project, it will automatically
use <code>renv</code> to work within a virtual environment. If you use
<code>renv</code> for the first time but on a project that already uses
it, when you open the R prompt in its root directory, the
<code>renv</code> package will be installed automatically.</p>
<p>Now that we have <code>renv</code>, we can, for example, install a
testing package with <code>install.packages("testthat")</code> and this
will not be a global installation, which means it will only work inside
this project. This is a way of isolating your project dependencies and
making your projects reproducible, by letting others know exactly which
packages your code needs to run, and not add unnecessary ones that you
may have because of other projects, as we mentioned previously.</p>
<p>The ‘list’ of required packages for the project, along with their
versions, which is used by <code>renv</code> to manage the virtual
environment, is in a file called <code>renv.lock</code>. After
installing new packages, this file is not updated automatically and we
have to do it manually by running</p>
<pre><code><span><span class="fu">renv</span><span class="fu">::</span><span class="fu">snapshot</span><span class="op">(</span><span class="op">)</span></span></code></pre>
<p>This will update the <code>renv.lock</code> file with all the
packages <code>renv</code> finds are used in your code. If for some
reason you need to install a package not explicitly used in the code,
this may fail to recognize it. In that case, you should instead
explicitly call <code>renv::snapshot(type="all")</code> to force every
package in your <code>renv</code> environment to be added to
<code>renv.lock</code>. You should push this file to the repository. If
someone else wants to reproduce your code, then they may have to run</p>
<pre><code><span><span class="fu">renv</span><span class="fu">::</span><span class="fu">restore</span><span class="op">(</span><span class="op">)</span></span></code></pre>
<p>which will install any packages from <code>renv.lock</code> that they
may still not have installed, but again, only on a project level, not
conflicting with their global R installation. If you use GitHub with
others, then you might also need to do this every time you pull remote
changes and someone else has included a new package, so that you are
then up to date with them. In any case, when opening the R shell, it
will probably remind you that there are missing packages in your virtual
environment with a message:</p>
<p><img src="imgs/renv_warn_packages_not_installed.png" alt="renv warns packages not installed"></p>
<p>And this is basically all you need to start using a virtual
environment, keeping in mind the commands</p>
<ul>
<li>
<code>renv::snapshot()</code>: add new required packages to
<code>renv.lock</code> file</li>
<li>
<code>renv::restore()</code>: install packages from
<code>renv.lock</code> that you do not have yet</li>
</ul>
<p>I wrote this introduction to <code>renv</code> by reading their own
package documentation. If you want to learn more about it, you can read
it yourself at <a href="https://rstudio.github.io/renv/articles/renv.html" class="external-link">their package
website</a>.</p>
<p>While this is not directly related to <code>renv</code> usage, I
wanted to highlight here that in Windows you may have errors trying to
install some R packages. Most of the times this may be related to
missing operating system dependencies or commands. In Windows this
should be easily fixable by installing the version of <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">Rtools</a> that
matches with your R version. After selecting the version you can
download it by clicking the first installer link. After installing
Rtools, you can try again to install the R packages you wanted.</p>
</div>
<div class="section level3">
<h3 id="writing-code">Writing code<a class="anchor" aria-label="anchor" href="#writing-code"></a>
</h3>
<p>Looking back at the package’s file structure, it is in the
<code>R/</code> directory where we will put all the main code. The R
files stored here must not contain any top-level code, that is, it must
all be inside functions. We can add more than one function in each file
if they are somehow related, but there must not be too many either. If a
file becomes too large and it has several functions inside, consider
splitting it into shorter files.</p>
<p>Take the following code as an example, written by our colleague
Justin (you do not have to understand the code, you can keep reading).
We save it in <code>R/sources.R</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Create a new dataframe where each row has a year range into one where each</span></span>
<span><span class="co">#' row is a single year, effectively 'expanding' the whole year range</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param trade_sources A tibble dataframe</span></span>
<span><span class="co">#' where each row contains the year range</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns A tibble dataframe where each row</span></span>
<span><span class="co">#' corresponds to a single year for a given source</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' trade_sources &lt;- tibble::tibble(</span></span>
<span><span class="co">#'   Name = c("a", "b", "c"),</span></span>
<span><span class="co">#'   Trade = c("t1", "t2", "t3"),</span></span>
<span><span class="co">#'   Info_Format = c("year", "partial_series", "year"),</span></span>
<span><span class="co">#'   Timeline_Start = c(1, 1, 2),</span></span>
<span><span class="co">#'   Timeline_End = c(3, 4, 5),</span></span>
<span><span class="co">#'   Timeline_Freq = c(1, 1, 2),</span></span>
<span><span class="co">#'   `Imp/Exp` = "Imp",</span></span>
<span><span class="co">#'   SACO_link = NA,</span></span>
<span><span class="co">#' )</span></span>
<span><span class="co">#' expand_trade_sources(trade_sources)</span></span>
<span><span class="va">expand_trade_sources</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trade_sources</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">non_na_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Trade"</span>, <span class="st">"Timeline_Start"</span>, <span class="st">"Timeline_End"</span>, <span class="st">"Timeline_Freq"</span><span class="op">)</span></span>
<span>  <span class="va">trade_sources</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu">.any_na_col</span><span class="op">(</span><span class="va">non_na_cols</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">.expand_trade_years</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      Name <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>        <span class="va">Info_Format</span> <span class="op">==</span> <span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">Name</span>, <span class="va">Year</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>, <span class="va">Name</span></span>
<span>      <span class="op">)</span>,</span>
<span>      ImpExp <span class="op">=</span> <span class="va">`Imp/Exp`</span>,</span>
<span>      In_Saco <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">SACO_link</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.expand_trade_years</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trade_sources</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trade_sources</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">trade_sources</span>, No <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">trade_sources</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">No</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">expand</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">Timeline_Start</span>, <span class="va">Timeline_End</span>, <span class="va">Timeline_Freq</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">trade_sources</span>, by <span class="op">=</span> <span class="st">"No"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.any_na_col</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cols_to_check</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">if_any</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">cols_to_check</span><span class="op">)</span>, <span class="va">is.na</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this sample code there are some things to keep in mind:</p>
<ul>
<li>All the code is written inside functions, and there are three of
them. The name of two of them starts with a dot. This is a convention
for private functions. Private functions are just helpers that are used
in other functions from the same file, they do not need to be used from
outside.</li>
<li>The functions that are not private, are then called public, and
those are the ones that we want to ‘export’, in the sense that we want
to allow for them to be used from outside this file. In our
<code>sources.R</code> example, the first function is public.</li>
<li>The public function has a large commented section before it, each
line starting with <code>#'</code>. This is a special type of comment
and it is considered documentation. Every public function
<strong>must</strong> be documented in the same way (more on this
special function documentation in the next section). The private
functions can be introduced by explanatory comments if you consider it
necessary, but they should be normal comments instead (starting with
just <code>#</code>, without the single quote).</li>
</ul>
<p>The most important take from here anyway is that these files should
contain all the code inside functions and nothing outside them.</p>
</div>
<div class="section level3">
<h3 id="function-documentation">Function documentation<a class="anchor" aria-label="anchor" href="#function-documentation"></a>
</h3>
<p>The special commented section seen in the previous example will be
used by a package called <a href="https://roxygen2.r-lib.org/" class="external-link"><code>roxygen2</code></a>. We have to
follow this exact syntax, so that this package can automatically build a
really neat documentation of our package for us. Let’s try to understand
its basic structure. For reference, these were the different parts:</p>
<ul>
<li>A small description of the function, nothing else.</li>
</ul>
<pre><code><span><span class="co">#' Create a new dataframe where each row has a year range into one where each</span></span>
<span><span class="co">#' row is a single year, effectively 'expanding' the whole year range</span></span></code></pre>
<ul>
<li>A small description of each parameter the function receives. It
should be like:</li>
</ul>
<pre><code><span><span class="co">#' @param param_name_1 Description of param 1</span></span>
<span><span class="co">#' @param param_name_2 Description of param 2</span></span>
<span><span class="co">#' ...</span></span></code></pre>
<p>As you see here I think it is OK to add line breaks in between, as
long as each parameter starts with <code>@param</code>.</p>
<pre><code><span><span class="co">#' @param trade_sources A tibble dataframe</span></span>
<span><span class="co">#' where each row contains the year range</span></span></code></pre>
<ul>
<li>A small description of the value the function returns. It should
start with <code>@returns</code>.</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @returns A tibble dataframe where each row</span></span>
<span><span class="co">#' corresponds to a single year for a given source</span></span></code></pre></div>
<ul>
<li>A simple line containing <code>@export</code> to indicate the
function can be used in the package, i.e., it is public.</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span></code></pre></div>
<ul>
<li>A ‘code’ section of examples to illustrate the function’s behavior.
It must start with <code>@examples</code>, and after that you can write
usual R code. When this is processed, it automatically runs the code and
adds some lines with its output in the documentation.</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @examples</span></span>
<span><span class="co">#' trade_sources &lt;- tibble::tibble(</span></span>
<span><span class="co">#'   Name = c("a", "b", "c"),</span></span>
<span><span class="co">#'   Trade = c("t1", "t2", "t3"),</span></span>
<span><span class="co">#'   Info_Format = c("year", "partial_series", "year"),</span></span>
<span><span class="co">#'   Timeline_Start = c(1, 1, 2),</span></span>
<span><span class="co">#'   Timeline_End = c(3, 4, 5),</span></span>
<span><span class="co">#'   Timeline_Freq = c(1, 1, 2),</span></span>
<span><span class="co">#'   `Imp/Exp` = "Imp",</span></span>
<span><span class="co">#'   SACO_link = NA,</span></span>
<span><span class="co">#' )</span></span>
<span><span class="co">#' expand_trade_sources(trade_sources)</span></span></code></pre></div>
<p>These options are enough to get us started with a nice documentation.
In the <a href="#writing-articles">Writing articles</a> section we will
learn how to generate and see this documentation. In this example, it
would look something like this (note the autogenerated example code
output):</p>
<p><img src="imgs/roxygen_documentation.png" alt="Auto generated documentation appearance"></p>
</div>
<div class="section level3">
<h3 id="package-data">Package data<a class="anchor" aria-label="anchor" href="#package-data"></a>
</h3>
<p>Some of the data we have to work with might be very large. If the
final datasets we want to produce are too large, we can’t directly
include them in the package because there are size limits and
recommendations. In that case, we will have to export them as
<em>functions</em>. In this way, the package itself won’t contain the
output dataset, but the user will have to generate it through running a
function, so it will be stored in their own computer. An example of this
is our function <code><a href="../reference/get_wide_cbs.html">get_wide_cbs()</a></code>. Unless we generate the
dataset ourselves in the function, we will also probably be using a very
large input dataset which we just process somehow. For reading large
datasets, see the relevant <a href="#reading-large-files">Reading large
files section</a>.</p>
<p>From now on, in this section we assume that you have some small
datasets (maybe up to a couple of megabytes) as inputs. We will go
through both public and private ones. The public ones are those that you
want to export to users of your package, and the private ones are only
intended for being used in your own code.</p>
<p>Let’s start with the exported datasets. The whole aim of this is to
allow users (or even our own code) to access them easily by writing
<code>my_pkg::my_dataset</code>. In order to achieve this, you must
follow these steps:</p>
<ol style="list-style-type: decimal">
<li>
<p>Create a file in <code>data-raw/my_dataset.R</code>. Scripts
inside the <code>data-raw</code> folder aren’t included as part of the
package. They will just be helpers for us to generate the actual data.
Inside this file we do some processing and, assuming we have a variable
called <code>my_dataset</code>, we end the script by calling
<code>usethis::use_data(my_dataset)</code>. This will automatically
create an <code>.rda</code> file in <code>data/my_dataset.rda</code>. We
have to manually run this script. After that, we can now refer to the
dataset as <code>my_pkg::my_dataset</code>.</p>
<p>You can directly create your data in the script
<code>data-raw/my_dataset.R</code>, or you can make it rather short by
just importing some data from another raw file. In this case, I
recommend having the raw file as a CSV in the <code>inst/extdata</code>
folder, say, <code>inst/extdata/my_raw_dataset.csv</code>. This is for
accessibility, so that everyone can see where this data comes from
regardless of whether they know how to read an <code>.rda</code> file or
not. A <code>data-raw/my_dataset.R</code> script could then look
like:</p>
</li>
</ol>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dataset</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"inst"</span>, <span class="st">"extdata"</span>, <span class="st">"my_raw_dataset.csv"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_data</span><span class="op">(</span><span class="va">my_raw_dataset</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Every time you introduce some change in the raw CSV file, you would
have to run this script again. The <code>overwrite = TRUE</code> is
exactly for this purpose, so that the <code>my_dataset.rda</code> file
is overwritten with the updated data.</p>
<ol start="2" style="list-style-type: decimal">
<li>Document your dataset. In the previous section we learned how to
document functions. Datasets aren’t functions, but they’re documented
very similarly. We start by creating a file <code>R/my_dataset.R</code>.
Note that the name matches that of <code>data-raw/my_dataset.R</code>.
It doesn’t need to match that of the variable used with
<code>usethis::use_data()</code>, but they should match each other. You
can define more than one dataset in the same file if you think they’re
related, so then you can also use a more general name for the file. This
is how you would document your dataset, also using <code>roxygen2</code>
comments:</li>
</ol>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Title of my dataset</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' My description of my dataset</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @format</span></span>
<span><span class="co">#' What my dataset is. I would ideally make it a tibble and explain all</span></span>
<span><span class="co">#' columns. My dataset contains the following columns:</span></span>
<span><span class="co">#' - `column_1`: My explanation of column 1.</span></span>
<span><span class="co">#' - `column_2`: My explanation of column 2.</span></span>
<span><span class="co">#' - `column_3`: My explanation of column 3.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @source Where my data comes from. Maybe an external link if you have one.</span></span>
<span><span class="st">"my_dataset"</span></span></code></pre></div>
<p>As you can see, we use <code>roxygen2</code> style comments right
before a line containing a character vector with the name of our
dataset, in this case <code>"my_dataset"</code>. Now your dataset will
be correctly documented after doing <code>devtools::document()</code>
and
<code><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">pkgdown::build_site()</a></code>/<code><a href="https://pkgdown.r-lib.org/reference/build_reference.html" class="external-link">pkgdown::build_reference()</a></code>.</p>
<p>Now we should talk about internal data. This is data that only the
developers of the package themselves use throughout the code. This could
be either actual tibble datasets or just bare constants. Any value that
doesn’t change and you would like to share throughout the whole package
code applies for this. Creating internal data is quite similar to
exported data:</p>
<ol style="list-style-type: decimal">
<li>Create a file <code>data-raw/constants.R</code> if it doesn’t
already exist. For internal data, all of them should be defined in this
same file. The file could look like this:</li>
</ol>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_constant_number</span> <span class="op">&lt;-</span> <span class="fl">0.65</span></span>
<span><span class="va">my_constant_name</span> <span class="op">&lt;-</span> <span class="st">"name"</span></span>
<span><span class="va">my_constant_tibble</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">col_1</span>, <span class="op">~</span><span class="va">col_2</span>,</span>
<span>  <span class="fl">1</span>,      <span class="fl">2</span>,</span>
<span>  <span class="fl">3</span>,      <span class="fl">4</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_data</span><span class="op">(</span></span>
<span>  <span class="va">my_constant_number</span>,</span>
<span>  <span class="va">my_constant_name</span>,</span>
<span>  <span class="va">my_constant_tibble</span>,</span>
<span>  internal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As you can see, you can pass more than one variable to
<code>usethis::use_data()</code>. We should include all our constants in
the same call to this function. In addition, it must also include the
<code>internal = TRUE</code> option to identify this as internal
data.</p>
<ol start="2" style="list-style-type: decimal">
<li>Manually run the previous file. This will create a single file in
<code>R/sysdata.rda</code>, which contains all your internal data. You
can now refer to these data the same way as for exported data, e.g.,
<code>my_pkg::my_constant_tibble</code> or
<code>my_pkg::my_constant_number</code>, but these will only be
available through the package’s code, and won’t be exported to the
package users. Again, any time you want to add new internal data or
modify the existing entries, you will have to manually run that script
again.</li>
</ol>
<p>Whether some data is worth being exported as part of the package or
just used as internal, this is your decision, but now you know how to
implement both. This section was heavily inspired by the <a href="https://r-pkgs.org/data.html" class="external-link"><em>Data</em> chapter</a> in the R
Packages book, which I recommend reading if you want to dive deeper.</p>
</div>
<div class="section level3">
<h3 id="writing-tests">Writing tests<a class="anchor" aria-label="anchor" href="#writing-tests"></a>
</h3>
<p>So we just wrote a function, we are done with it, we now move to
another function… No. You probably thought that we should check somehow
that this function is indeed correct and it does what you expect. Right
now it would be easy to just load the function in an R prompt and try
some examples on it, but what if the next month someone has to make a
change in this code? They would have to do this manual testing again to
make sure they did not break any functionality. What if they need to
change dozens of functions? How much time will they spend on testing all
of them?</p>
<p>I think you can understand that this is really time consuming and
that there is a better way. Tests can be automatized. We can write some
tests whenever we create a new function, that together prove the
function does what we expect, and if later on we add some changes to the
function, we already have a test that can be run automatically to see if
the function is still correct. Of course, this is not completely
accurate. Maybe when we changed the function, some of its functionality
was also changed, so the test is not accurate anymore and has to be
tweaked as well, to represent what we really want. But this is still
much less work than always testing the function manually in an R prompt,
and eventually you just get used to it.</p>
<p>The package that is used to write tests and is well integrated into
the R package creation workflow is <a href="https://testthat.r-lib.org/index.html" class="external-link">testthat</a>. We will be
using it to write our automated tests. Again, looking at the structure
of an R package, the tests go into (surprise!) the directory
<code>tests/</code>. In this directory there is a file called
<code>testthat.R</code> that setups <code>testthat</code> and should not
be changed, and the actual tests that we write will go into the
<code>tests/testthat/</code> subdirectory. The convention is to name the
test files the same way as the R files but with a <code>test-</code>
prefix. In our case, for example, if we have an R file in
<code>R/sources.R</code>, then our test file should be
<code>tests/testthat/test-sources.R</code>. Let’s see how one of our
tests could look like:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://testthat.r-lib.org" class="external-link">"testthat"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"trade source data is expanded from year range to single year rows"</span>, <span class="op">{</span></span>
<span>  <span class="va">trade_sources</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    Name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"d"</span>, <span class="st">"e"</span><span class="op">)</span>,</span>
<span>    Trade <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"t1"</span>, <span class="st">"t2"</span>, <span class="st">"t3"</span>, <span class="cn">NA</span>, <span class="st">"t5"</span><span class="op">)</span>,</span>
<span>    Info_Format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"partial_series"</span>, <span class="st">"year"</span>, <span class="st">"year"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>    Timeline_Start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    Timeline_End <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    Timeline_Freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    `Imp/Exp` <span class="op">=</span> <span class="st">"Imp"</span>,</span>
<span>    SACO_link <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">expected</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    Name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a_1"</span>, <span class="st">"a_2"</span>, <span class="st">"a_3"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"c_2"</span>, <span class="st">"c_4"</span><span class="op">)</span>,</span>
<span>    Trade <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"t1"</span>, <span class="st">"t1"</span>, <span class="st">"t1"</span>, <span class="st">"t2"</span>, <span class="st">"t2"</span>, <span class="st">"t2"</span>, <span class="st">"t2"</span>, <span class="st">"t3"</span>, <span class="st">"t3"</span><span class="op">)</span>,</span>
<span>    Info_Format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"year"</span>, <span class="st">"year"</span>, <span class="st">"year"</span>, <span class="st">"partial_series"</span>, <span class="st">"partial_series"</span>,</span>
<span>      <span class="st">"partial_series"</span>, <span class="st">"partial_series"</span>, <span class="st">"year"</span>, <span class="st">"year"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">actual</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">trade_sources</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/expand_trade_sources.html">expand_trade_sources</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">actual</span>, <span class="va">Name</span>, <span class="va">Trade</span>, <span class="va">Info_Format</span>, <span class="va">Year</span><span class="op">)</span>,</span>
<span>    <span class="va">expected</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Again, you do not have to understand the whole code. Just note that
we use two functions from the <code>testthat</code> package:</p>
<ul>
<li>
<code><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">testthat::test_that</a></code>: this is the main function used to
delimit what a test is. It receives a text description about what the
test is checking, and a body containing all the code of the test
itself.</li>
<li>
<code><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">testthat::expect_equal</a></code>: this is just one of the many
utilities <code>testthat</code> brings to actually assert things in the
test’s code. It is probably the most general assert, and it just checks
if everything is identical in both arguments, including internal object
metadata, not just “appearance” (what you may see when printing an
object). You can look for more testing utility functions in <a href="https://testthat.r-lib.org/reference/index.html" class="external-link">their
documentation</a>.</li>
</ul>
<p>So now we have a test. How do we execute it? It is not recommended to
run the test as usual R code (e.g. run the file as a script). Instead,
there are some functions provided by <code>testthat</code> for running
tests. Here are some of them:</p>
<ul>
<li>
<code><a href="https://testthat.r-lib.org/reference/auto_test_package.html" class="external-link">testthat::auto_test_package()</a></code>: This one will run all
the tests in the package the first time, and after that it will not stop
running, but wait for code changes. This means that whenever you ‘save’
a test file, it only reruns all the tests in that file. This is
extremely useful when you are actively writing some tests, so that you
can get fast feedback.</li>
<li>
<code><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">testthat::test_file()</a></code>: This one receives as argument
the path to a test file, and it only runs the tests inside it. For
example, we could run in our case
<code>testthat::test_file("tests/testthat/test-sources.R")</code>.</li>
<li>
<code><a href="https://testthat.r-lib.org/reference/test_dir.html" class="external-link">testthat::test_dir()</a></code>: In this case, this could be
different to running all the tests if we had e.g. some subdirectories in
the <code>tests/testthat</code> one. If there was a subdirectory
<code>tests/testthat/sources</code> with many test files related to
sources, we could run
<code>testthat::test_dir("tests/testthat/sources")</code> and all test
files inside this directory would be executed.</li>
<li>
<code><a href="https://testthat.r-lib.org/reference/test_package.html" class="external-link">testthat::test_package()</a></code>: This is the most general one.
It just runs all the tests in the project.</li>
</ul>
<p>All of these can be useful to run tests while you are actively
working on them. You are supposed to make all your tests pass, and as we
will see in the next section, there are some more checks a package must
pass to be valid (so that it can be publicly uploaded), but tests are
definitely one of them.</p>
</div>
<div class="section level3">
<h3 id="r-cmd-check">R CMD Check<a class="anchor" aria-label="anchor" href="#r-cmd-check"></a>
</h3>
<p>There is a standard tool that contains several steps (‘checks’) which
every project that wants to be a package uploaded to <a href="https://cran.r-project.org/" class="external-link">CRAN repositories</a> must pass. As
part of our code workflow, you are also responsible to make this check
pass, as we will also see in the <a href="#automatic-checks-on-pull-requests">Automatic checks on Pull
Requests</a> section. This check is known as ‘R CMD check’, and it is
actually very easy to run:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">check</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The whole output of this call is rather long, since it lists all the
different checks it makes, but at the end, if there are no issues, this
is the output you should see:</p>
<p><img src="imgs/r_cmd_check_pass.png" alt="Correct output of R CMD check"></p>
<p>OK, but if you just followed the steps in this guide and included our
example code from the <a href="#writing-code">Writing code</a> and <a href="#writing-tests">Writing tests</a> sections, the above check should
not have ended successfully with 0 errors, and you probably see (among
the really large output), some error like this:</p>
<p><img src="imgs/r_cmd_check_fail.png" alt="Error no package called tidyr"></p>
<p>The problem here is that before performing the check on your package,
it must build it. And for that, it must know which other packages it has
as dependencies. Again, if you just followed everything from here, we
never got to do that, so your built package just does not include any
other packages. To fix this, we must have a quick look at the
<code>DESCRIPTION</code> file.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="an">Package:</span><span class="co"> whep</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="an">Title:</span><span class="co"> What the Package Does (One Line, Title Case)</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="an">Version:</span><span class="co"> 0.0.0.9000</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>Authors@R:</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>    person("First", "Last", , "first.last@example.com", role = c("aut", "cre"))</span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>Description: What the package does (one paragraph).</span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a>License: MIT + file LICENSE</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a>Imports:</span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a>    dplyr,</span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a>    tidyr</span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a>Encoding: UTF-8</span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a>Roxygen: list(markdown = TRUE)</span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a>RoxygenNote: 7.3.2</span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a>Suggests:</span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a>    knitr,</span>
<span id="cb34-16"><a href="#cb34-16" tabindex="-1"></a>    rmarkdown,</span>
<span id="cb34-17"><a href="#cb34-17" tabindex="-1"></a>    testthat (&gt;= 3.0.0),</span>
<span id="cb34-18"><a href="#cb34-18" tabindex="-1"></a>    tibble,</span>
<span id="cb34-19"><a href="#cb34-19" tabindex="-1"></a>    ggplot2,</span>
<span id="cb34-20"><a href="#cb34-20" tabindex="-1"></a>    here,</span>
<span id="cb34-21"><a href="#cb34-21" tabindex="-1"></a>    googlesheets4</span>
<span id="cb34-22"><a href="#cb34-22" tabindex="-1"></a>Config/testthat/edition: 3</span>
<span id="cb34-23"><a href="#cb34-23" tabindex="-1"></a>VignetteBuilder: knitr</span>
<span id="cb34-24"><a href="#cb34-24" tabindex="-1"></a>URL: https://eduaguilera.github.io/whep/</span></code></pre></div>
<p>In the above file, the <code>Imports</code> section is where we
should make sure we have all dependencies for code which was saved
specifically in the <code>R/</code> directory. On the other hand,
dependencies for code written in other places, such as
<code>tests/</code> or <code>vignettes/</code> (we will see this one in
the following <a href="#writing-articles">Writing articles</a> section),
should be included in the <code>Suggests</code> section of the
<code>DESCRIPTION</code> file. Together these two fields tell everyone
which dependencies our package needs to work correctly. After adding
these, you could run again <code>devtools::check()</code> and confirm
that it does not fail anymore (at least no errors).</p>
<p>We will not go into detail as to which checks are being performed. We
will all slowly learn about them whenever they show up as real issues in
our code when running the check tool. Just keep in mind that one of the
important points is that all the tests you write are also executed here,
and the ‘R CMD check’ also fails if one of your tests fail. If you
really want to know more about the checks, you can read, e.g., <a href="https://r-pkgs.org/R-CMD-check.html" class="external-link">this detailed list</a>.</p>
</div>
<div class="section level3">
<h3 id="writing-articles">Writing articles<a class="anchor" aria-label="anchor" href="#writing-articles"></a>
</h3>
<p>If you ever got to check some popular R package website (e.g. <a href="https://dplyr.tidyverse.org/index.html" class="external-link">dplyr</a>), you may know
there is a section called <code>Articles</code> at the top, and if you
open one of them, you see what indeed looks like an article, mixing
natural text and code rendering. This is ideal if you want to make
guides about your package, or some kind of reports in general. As you
can probably guess, this guide that you are reading was built the same
way. Luckily this is already very well integrated with the R packages
workflow, and we will learn how to make our own articles here
easily.</p>
<p>Everything that we want to appear in this <code>Articles</code>
section of the site, should be included in the <code>vignettes/</code>
directory of the package. And inside this directory, each file that ends
with a <code>.Rmd</code> extension will be considered one article. The
extension name stands for ‘R Markdown’, which is a mix of R code and
Markdown text. If you do not know about Markdown you can start with,
e.g., <a href="https://www.markdownguide.org/basic-syntax/" class="external-link">this
intro</a>. Following our previous example, we can create a file called
<code>trade-sources-coverage.Rmd</code> with the following code <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;If you copy it, please &lt;strong&gt;remove the _ from
starting code block lines, e.g., change &lt;code&gt;```_{r, ...}&lt;/code&gt; to
&lt;code&gt;```{r, ...}&lt;/code&gt;&lt;/strong&gt;. I cannot render R Markdown code
properly inside an R Markdown file itself in this guide, because it
tries to execute the code block anyway, and this is a workaround so that
this guide renders properly. Do tell me if you know of a correct way to
handle this.&lt;/p&gt;"><sup>1</sup></a> (again,
thanks to Justin):</p>
<pre><code>---
title: "Trade sources year coverage"
output: rmarkdown::html_vignette
vignette: &gt;
  %\VignetteIndexEntry{Trade sources year coverage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```_{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#&gt;"
)
```

```_{r setup}
library(whep)
key_path &lt;- here::here(Sys.getenv("GOOGLESHEETS_AUTH_FILE"))
googlesheets4::gs4_auth(path = key_path)
```

First we read the trade sources sheet and build a dataframe where each row accounts for one year.
```_{r}
# Step 1: Authentication
sheet_url &lt;- "1UdwgS87x5OsLjNuKaY3JA01GoI5nwsenz62JXCeq0GQ"

# PART 1: trade_sources FOR TRADE

# Step 2: Rest of Program
expanded_trade_sources &lt;-
  sheet_url |&gt;
  googlesheets4::read_sheet(sheet = "Final_Sources_Trade") |&gt;
  expand_trade_sources()
```

Now we build some plots.

Plot showing years covered by `expanded_trade_sources`:
```_{r, fig.alt="Plot showing years covered by expanded_trade_sources"}
ggplot2::ggplot(
  expanded_trade_sources,
  ggplot2::aes(y = Trade, x = Year, fill = "lightblue")
) +
  ggplot2::geom_tile(alpha = .8) +
  ggplot2::theme_dark() +
  ggplot2::labs(title = "Source Availability by Country") +
  ggplot2::scale_fill_identity() +
  ggplot2::facet_wrap(~Reporter, ncol = 1)
```</code></pre>
<p>The first part of this code, namely the following</p>
<pre><code>---
title: "Trade sources year coverage"
output: rmarkdown::html_vignette
vignette: &gt;
  %\VignetteIndexEntry{Trade sources year coverage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```_{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#&gt;"
)
```</code></pre>
<p>is metadata and should always be present (just change the article’s
title). You see that just as in Markdown, we can write R code chunks
inside triple backticks, but the difference here is that this code will
be executed, and by default we will also be able to see its output in
the rendered article.</p>
<p>The next chunk (with the <code>"r setup"</code> option) is used for
some initialization code that you may need throughout the rest of the
article. At the time of writing I do not really know the implications of
writing the <code>"r setup"</code> option or writing this code in a
normal R code chunk (without the option), but it is at least good
practice. Note that the package being loaded is your own package (called
whep in our case).</p>
<pre><code>```_{r setup}
library(whep)
key_path &lt;- here::here(Sys.getenv("GOOGLESHEETS_AUTH_FILE"))
googlesheets4::gs4_auth(path = key_path)
```</code></pre>
<p>The rest of the code provided is just some usual Markdown text
intertwined with usual R code chunks. In the special case of code chunks
with plots, we will get to see the actual plot in the rendered article,
and the <code>fig.alt</code> option is necessary in order not to get an
R CMD check warning, and will only be used as text which explains the
rendered image for people using screen readers or in the case it cannot
be displayed correctly in a browser.</p>
<p>Now that we have our R Markdown article, we would like to visualize
it. There are at least two useful R commands for this. The first one
creates the whole documentation website locally in our computers, and it
automatically opens your browser on the site. This is simply:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">build_site</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We should now be able to see our article in the ‘Articles’ section.
It should look something like the one you can see directly on this site
at <a href="trade-sources-coverage.html">Trades sources coverage</a>
(with some additional plots).</p>
<p>After running this command once, there is no need to rerun it every
time we want to see changes, since it takes a bit longer to run. We can
instead use a simpler one</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_articles.html" class="external-link">build_articles</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>which checks for code changes in articles and only reruns those that
have changed. I am not completely convinced they are equivalent, since
it seems at some point one failed and one worked for me, but if you are
not doing something strange (like me building this guide and writing R
Markdown inside R Markdown) it should probably work the same.</p>
<p>The <code><a href="https://pkgdown.r-lib.org/reference/build_articles.html" class="external-link">pkgdown::build_articles()</a></code> one could still fail with
some error indicating that the package cannot be loaded. It most likely
refers to your own package. Since you use code from your own package
inside the R markdown, this package itself must also be installed. When
running <code><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">pkgdown::build_site()</a></code>, I think the package is
installed but only in a temporary directory for that execution, so maybe
it does not work anymore when calling
<code><a href="https://pkgdown.r-lib.org/reference/build_articles.html" class="external-link">pkgdown::build_articles()</a></code> after that. If this is your case,
you may want to try installing your own package first via
<code>devtools::install()</code>. Note that this assumes you do not
change your package code (the one in <code>R/</code> directory) while
actively working on articles. If you do, you would have to reinstall
your own package every time you change something in the <code>R/</code>
directory.</p>
<p>As mentioned in a previous section, also remember to include all
package dependencies your article code uses in the <code>Suggests</code>
part of the <code>DESCRIPTION</code> file, so that you do not get errors
of packages not being found when building the articles or running R CMD
check.</p>
<p>This way we can render our articles by default in HTML, which is what
browsers use. Having your own site is perfect because you can keep it up
to date, but in case you need it, you should also be able to export an
article as PDF. For this to work, you first need a LaTeX distribution
installed. If you are on Windows, you can try MiKTeX (<a href="https://miktex.org/howto/install-miktex" class="external-link">maybe start from
here</a>). Remember to choose “Yes” when asked for “missing packages
installation on the fly”, otherwise our PDF generation from R might
fail. Once we have a LaTeX distribution installed, we can build a PDF
from our article with just a single command:</p>
<pre><code><span><span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/render.html" class="external-link">render</a></span><span class="op">(</span><span class="st">"vignettes/my-vignette.Rmd"</span>, output_format <span class="op">=</span> <span class="st">"pdf_document"</span><span class="op">)</span></span></code></pre>
<p>The output PDF (probably as expected) does not look exactly like the
one from the site, but it has its own style (LaTeX’s style). There are
also other valid formats, you can look them up if you are curious, but I
thought the PDF output format would be the most useful one besides the
HTML for website generation.</p>
</div>
<div class="section level3">
<h3 id="environment-variables-and-secrets">Environment variables and secrets<a class="anchor" aria-label="anchor" href="#environment-variables-and-secrets"></a>
</h3>
<p>When running code, you can sometimes customize some behavior by
specifying the value of some variable to your needs. For example, maybe
there is an option whose value is a number from 1 to 5, indicating the
level of debugging (the amount of output you want to see in the console,
so as to understand the code’s execution). A possible way of introducing
this would be with what is known as an ‘environment variable’, which is
just a value stored with a name in the ‘environment’ where your code
runs (not an R variable, it is more related to the operating system).
These should be loaded before the code starts running, and our package
workflow allows us to do this quite easily, by creating a top-level file
called <code>.Renviron</code>, which can include one variable per line,
like this:</p>
<pre><code><span><span class="va">DEBUG_LEVEL</span><span class="op">=</span><span class="fl">1</span></span>
<span><span class="va">GOOGLESHEETS_AUTH_FILE</span><span class="op">=</span><span class="va">inst</span><span class="op">/</span><span class="va">google_cloud_key.json</span></span></code></pre>
<p>It can be accessed from R code by using</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"NAME_OF_VARIABLE"</span><span class="op">)</span></span></code></pre></div>
<p>You can also use environment variables for constants, or whatever you
feel that could be used in several places. This file will be uploaded to
the repository, so it is important that it does not contain any
sensitive information (also known as ‘secrets’). I also introduced this
section because in the example code for the <a href="#writing-articles">Writing articles</a> section, there is the
line:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key_path</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GOOGLESHEETS_AUTH_FILE"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In that example, an Excel sheet must be read. When using the
<code>googlesheets4</code> package, it can automatically open a browser
interactively and ask for your Google account credentials, but when
running check tools, we want everything to work from beginning to end
without human intervention. This is achievable by providing a secret
token <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;For educational purposes I won’t change anything from
this explanation in the guide. However, recently I found out that the
token is not needed when you’re reading public files. For this to work
automatically we only have to call
&lt;code&gt;&lt;a href="https://googlesheets4.tidyverse.org/reference/gs4_deauth.html" class="external-link"&gt;googlesheets4::gs4_deauth()&lt;/a&gt;&lt;/code&gt; before reading the public
file.&lt;/p&gt;'><sup>2</sup></a>.</p>
<p>Since we <em>must not</em> include secret information in
<code>.Renviron</code>, the workaround is to instead add just the secret
file path as an environment variable and then read from it, so the
<code>.Renviron</code> is uploaded to GitHub but the secret file, which
according to our environment variable should be found in
<code>inst/google_cloud_key.json</code>, <em>is not uploaded</em>.
Instead, the file should be uploaded to another private storage service,
so that only you have access to it.</p>
<p>In examples like this one, ideally every developer would create and
use their own token. The specific case of the token in this example is
out of the scope of this guide, but if you are interested you could
probably start from <a href="https://gargle.r-lib.org/articles/get-api-credentials.html" class="external-link">this
<code>gargle</code> package guide</a>. Also, the <code>here</code>
package was used above for easy file path referencing from the root
directory of a project, so that paths are not hard-coded, and you can
read more in <a href="https://here.r-lib.org/" class="external-link">their package
site</a>.</p>
</div>
<div class="section level3">
<h3 id="r-code-style-and-formatting">R code style and formatting<a class="anchor" aria-label="anchor" href="#r-code-style-and-formatting"></a>
</h3>
<p>There are some conventions and good practices for how to write neat
code in R. The most followed style guide is the <a href="https://style.tidyverse.org/" class="external-link">Tidyverse style guide</a>. You can
read it or just skim through it to get a grasp of their conventions. The
key is that most of them can be checked automatically. There are tools
which conform to these standards and let you apply the necessary changes
to the code by just clicking one button. Analogously, there are also
ways to check whether a code is correctly following a style or not,
without explicitly changing it. In the context of the Tidyverse style
guide, these two points directly match with two R packages:</p>
<ul>
<li>
<p><code>styler</code>: it applies the Tidyverse style guide to a
specific code, be it a chunk, a file or an entire project. For example,
we could apply the style to the whole package by simply using the
command:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">styler</span><span class="fu">::</span><span class="fu">style_pkg</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Most code editors incorporate some way of doing this. Since you are
most likely using RStudio, you can do it by finding the
<code>styler</code> options in the ‘addins’ drop-down:</p>
<p><img src="imgs/styler_rstudio.png" alt="Use styler package from RStudio"></p>
<p>When using <code>renv</code>, it seems RStudio only shows in the
‘addins’ drop-down the options from packages included in
<code>renv</code>, so keep that in mind in case you want it in a
different project, that is, if <code>styler</code> does not show up
there, it means you do not have it installed in the current
<code>renv</code> environment.</p>
<p>An important thing to keep in mind is that the Tidyverse style guide
states lines should have at most 80 characters, but the
<code>styler</code> package cannot by itself try to separate a really
long single line into several lines to match the 80 character limit. You
<em>must</em> fix this anyway, and the usual way for the
<code>styler</code> to work is to first manually split some of the code
into two lines, and then run the <code>styler</code> again, so it can
now split the rest accordingly. For example, you have:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">call_my_incredibly_long_function</span><span class="op">(</span><span class="va">my_first_long_argument</span>, <span class="va">my_second_long_argument</span>, <span class="va">my_third_long_argument</span><span class="op">)</span></span></code></pre></div>
<p>In this case, if you use <code>styler</code> it may not change
anything and still leave this code in a single line, but you can help it
a bit by sending the arguments to the next line, like this:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">call_my_incredibly_long_function</span><span class="op">(</span></span>
<span>  <span class="va">my_first_long_argument</span>, <span class="va">my_second_long_argument</span>, <span class="va">my_third_long_argument</span><span class="op">)</span></span></code></pre></div>
<p>This does not conform to the standard yet, but now trying to use
<code>styler</code> again, it should be able to understand what is going
on and split the code accordingly. Depending on the length of the line,
it may leave it like this (note the closing parenthesis goes in its own
line):</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">call_my_incredibly_long_function</span><span class="op">(</span></span>
<span>  <span class="va">my_first_long_argument</span>, <span class="va">my_second_long_argument</span>, <span class="va">my_third_long_argument</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Or if the line was even longer, it would split each argument into its
own line:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">call_my_incredibly_long_function</span><span class="op">(</span></span>
<span>  <span class="va">my_first_long_argument</span>,</span>
<span>  <span class="va">my_second_long_argument</span>,</span>
<span>  <span class="va">my_third_long_argument</span>,</span>
<span>  <span class="va">my_fourth_long_argument</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Any of those should work now, because they successfully follow the 80
character per line limit. If you do not follow the limit, you would fail
the <code>lintr</code> check (see next point below).</p>
</li>
<li>
<p><code>lintr</code>: it checks whether the given code/file/project
follows the Tidyverse style guide, without making any actual changes.
You are responsible for making sure this check passes (probably using
<code>styler</code> as explained above), since it will also be
automatically checked on your Pull Requests (see the <a href="#automatic-checks-on-pull-requests">next section</a> on this
guide). The check we will use is:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lintr</span><span class="fu">::</span><span class="fu"><a href="https://lintr.r-lib.org/reference/lint.html" class="external-link">lint_package</a></span><span class="op">(</span></span>
<span>  linters <span class="op">=</span> <span class="fu">lintr</span><span class="fu">::</span><span class="fu"><a href="https://lintr.r-lib.org/reference/linters_with_defaults.html" class="external-link">linters_with_defaults</a></span><span class="op">(</span>object_usage_linter <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The default call would be as easy as
<code><a href="https://lintr.r-lib.org/reference/lint.html" class="external-link">lintr::lint_package()</a></code>. I will not go into detail about the
specific option added here, but it is there to ignore warnings about
undeclared global variables, which are false positives when using
<code>dplyr</code> column names. For convenience, if you are following
our <a href="https://github.com/lbm364dl/R-example" class="external-link">example
repository</a>, you could find this call in
<code>inst/scripts/check_lint.R</code>, so if you want to check
everything you would just have to run this script.</p>
<p>In the screenshot above you can see there are also options for
<code>lintr</code> checks from Rstudio’s ‘addins’, but by default they
perform the <code><a href="https://lintr.r-lib.org/reference/lint.html" class="external-link">lintr::lint_package()</a></code> call without any options.
Remember we added one option to our check, so you should either find out
how to change the default behavior or just run the script we included in
<code>inst/scripts/check_lint.R</code>.</p>
</li>
</ul>
<p>Again, as you can see in the screenshot, there are more things you
can do directly from RStudio (like running tests or building
documentation). In this guide I tried to provide a code editor agnostic
approach for everything. Since I do not use RStudio myself, I am not
particularly familiar with its functionalities, so if you think they may
be helpful to you, you can check them yourself.</p>
</div>
<div class="section level3">
<h3 id="reading-large-files">Reading large files<a class="anchor" aria-label="anchor" href="#reading-large-files"></a>
</h3>
<p>Many packages don’t work with data per se. Others need data, but
their datasets are small enough to be directly included in the package
(and thus the code repository). GitHub has a limit on file size of <a href="https://docs.github.com/en/repositories/working-with-files/managing-large-files/about-large-files-on-github" class="external-link">100
MiB</a>, but even adding such files will make working with the
repository noticeably slow. My recommendation for us is to consider a
file <em>large</em> if it has more than a couple of megabytes. Assuming
our package needs to work with <em>large</em> files, we need to find a
workaround that is not storing them in GitHub. After thinking about this
for a while, I considered using the <a href="https://pins.rstudio.com/articles/pins.html" class="external-link"><code>pins</code></a>
package. I encourage you to read through that <em>Get started</em>
guide, since I won’t explain too much about this package itself, but
rather how we implement it in our workflow.</p>
<p>A <code>pins</code> board is like a repository but for files. You can
even store a version history of them. Here we assume that someone
already created a board for you. If you just want to use a file someone
else already added, you don’t need any of the following. See the
documentation for <code><a href="../reference/whep_read_file.html">whep_read_file()</a></code>. However, if you need a
new file that is still not uploaded, or a new version of an existing
one, you’ll need to do these steps:</p>
<ol style="list-style-type: decimal">
<li>Prepare a local version of your data. I created a script helper for
us, which can be found in the <a href="https://github.com/eduaguilera/whep/blob/main/inst/scripts/prepare_upload.R" class="external-link"><code>whep</code>
repository</a>. You have to fill your own local data path and a name for
the data, run the script and follow the instructions. For example, I
could set the following</li>
</ol>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">prepare_for_upload</span><span class="op">(</span></span>
<span><span class="st">"~/Downloads/Processing_coefs.csv"</span>,</span>
<span><span class="st">"processing_coefs"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Creating new version '20250716T102305Z-f8189'</span></span>
<span><span class="co">#&gt; ℹ 1. Manually upload the folder /tmp/RtmpHFHNUO/pins-1f3c39c418e0/processi</span></span>
<span><span class="co">#&gt; ng_coefs/20250716T102305Z-f8189 into your board. Folder path copied to you</span></span>
<span><span class="co">#&gt; r clipboard.</span></span>
<span><span class="co">#&gt; ℹ 2. Add the corresponding line</span></span>
<span><span class="co">#&gt; - processing_coefs/20250716T102305Z-f8189/</span></span>
<span><span class="co">#&gt; in _pins.yaml at the end of the 'processing_coefs:' section</span></span>
<span><span class="co">#&gt; ℹ 3. If you want the package to use this version, add a new row to whep_in</span></span>
<span><span class="co">#&gt; puts.csv if it's a new file or update the version in the existing row. The</span></span>
<span><span class="co">#&gt;  version is 20250716T102305Z-f8189.</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>A temporary local folder is created whose name is the data version.
You must upload this folder inside the one with the data’s name in the
public board, assuming you have write access.</li>
</ol>
<p><img src="imgs/new_version_uploaded.png" alt="New version uploaded"></p>
<ol start="3" style="list-style-type: decimal">
<li>You must add one line to the <code>_pins.yaml</code> file in the
root folder of the board, like it’s specified in the instructions. This
is an internal file that the <code>pins</code> package uses to keep
track of files and versions.</li>
</ol>
<p><img src="imgs/update_pins_yaml.png" alt="Update _pins.yaml"></p>
<ol start="4" style="list-style-type: decimal">
<li>To use the version in the next package release, you must also update
the version inside the <a href="https://github.com/eduaguilera/whep/blob/main/inst/extdata/whep_inputs.csv" class="external-link"><code>whep_inputs.csv</code></a>
file:</li>
</ol>
<pre><code>alias,board_url,version
...
processing_coefs,https://some/url/to/_pins.yaml,20250716T102305Z-f8189
...</code></pre>
<p>And now you’re done. You added a new file or a new version, and you
can now access it from the code by using the
<code><a href="../reference/whep_read_file.html">whep_read_file()</a></code> function.</p>
<p>If you’re wondering why there are manual steps in this process and
the script doesn’t automate everything, it’s because our storage service
is hosted by a Nextcloud server, and the easiest way to interact with it
from outside is having a synced version of the whole storage locally. I
thought some people might not be able to afford that, and since we don’t
have to upload new data files often, I decided a few manual steps
wouldn’t hurt that much.</p>
</div>
<div class="section level3">
<h3 id="automatic-checks-on-pull-requests">Automatic checks on Pull Requests<a class="anchor" aria-label="anchor" href="#automatic-checks-on-pull-requests"></a>
</h3>
<p>By this point we assume you are already done with all your new code,
you documented and tested it, or perhaps you just created some report in
the form of an article. As we have seen in the <a href="#git-intro">Git
intro</a>, it is now time to create a Pull Request so that someone else
reviews what you have done. But when you create the Pull Request, our
workflow is designed so that two checks are run automatically on GitHub,
each time you push your changes to a branch which has an open Pull
Request:</p>
<ul>
<li>First, the R CMD check is performed. We have seen in a previous
section how you can run it locally, so you should have made sure it
outputs no errors. Otherwise, you will see this step failing.</li>
<li>Then, a linting check is performed. We have also seen how to
autoformat your code, so that it follows the R code styling standards,
and how to make sure that it is indeed well formatted. Otherwise, you
will see this step failing.</li>
</ul>
<p>If any of the steps above fail, you will see something like this in
your PR page:</p>
<p><img src="imgs/github_action_fail.png" alt="GitHub Action check fails"></p>
<p>Otherwise, if both checks succeeded, you will see something like:</p>
<p><img src="imgs/github_action_pass.png" alt="GitHub Action check succeeds"></p>
<p>Overall, you should be able to see this at the bottom of the PR:</p>
<p><img src="imgs/all_pr_ok.png" alt="GitHub Action Pull Request passed"></p>
<p>In case you are wondering, both checks we mentioned before are
actually done in a single GitHub automatic step (these steps are called
‘GitHub actions’), so it should say ‘1 successful check’ instead of ‘2
successful checks’. However, there is an additional GitHub action there,
which essentially just updates the documentation site (only when the PR
is actually merged into the main branch). This is not relevant to you as
a developer but it makes the overall workflow easier, since the project
documentation is automatically updated without any more human
intervention. If you want to know more about this automatic site update
you can check this <a href="https://r-pkgs.org/website.html" class="external-link">section
from the R Packages book</a>.</p>
<p>Recall that for a PR to be accepted and merged into the main branch,
it must also be reviewed by another developer. A good practice would be
to make sure the GitHub checks pass before even asking for someone’s
reviewing, because if any check failed you most likely need to add more
code changes to fix them, so some of the code the reviewer could have
checked before could become obsolete, and they would have to read it
again, so we better avoid that.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Catalin Covaci, Eduardo Aguilera, <a href="https://erc.europa.eu/homepage" class="external-link"><img src="https://erc.europa.eu/themes/custom/erc_theme/ERC_FAVICON.png" width="55" alt="European Research Council"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
